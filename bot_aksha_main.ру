import os
import telebot
import requests
import time
import threading

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
TOKEN = os.getenv("BOT_TOKEN")
bot = telebot.TeleBot(TOKEN)

# –ò—Å—Ç–æ—Ä–∏—è –∫—É—Ä—Å–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (—Ö—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–Ω–∞—á–µ–Ω–∏–π)
course_history = []

def get_current_rate():
    """–ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –∫—É—Ä—Å USD/KZT —á–µ—Ä–µ–∑ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–µ API"""
    try:
        url = "https://api.exchangerate-api.com/v4/latest/USD"
        data = requests.get(url).json()
        return data['rates']['KZT']
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–∞: {e}")
        return None

def monitor_logic():
    """–§–æ–Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π"""
    global course_history
    while True:
        current_price = get_current_rate()
        if current_price:
            course_history.append(current_price)
            if len(course_history) > 10:
                course_history.pop(0)

            # –ü—Ä–æ—Å—Ç–µ–π—à–∏–π –∞–Ω–∞–ª–∏–∑: –µ—Å–ª–∏ –∫—É—Ä—Å –≤—ã—Ä–æ—Å –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 0.5 –∑–∞ –æ–¥–Ω—É –ø—Ä–æ–≤–µ—Ä–∫—É
            if len(course_history) > 1:
                diff = course_history[-1] - course_history[-2]
                if abs(diff) > 0.3:
                    status = "üìà –†–∞—Å—Ç–µ—Ç" if diff > 0 else "üìâ –ü–∞–¥–∞–µ—Ç"
                    print(f"–í–Ω–∏–º–∞–Ω–∏–µ! –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ —Ä–µ–∑–∫–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ: {status} –Ω–∞ {round(diff, 2)} —Ç–µ–Ω–≥–µ")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç
        time.sleep(900)

@bot.message_handler(commands=["start"])
def start(message):
    rate = get_current_rate()
    text = f"ü§ñ –ë–æ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ USD/KZT –∑–∞–ø—É—â–µ–Ω!\n\n"
    if rate:
        text += f"üíµ –¢–µ–∫—É—â–∏–π –∫—É—Ä—Å: {rate} KZT\n"
    text += "üìä –Ø –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ä—ã–Ω–æ–∫ –∏ —Å–æ–æ–±—â—É, –µ—Å–ª–∏ –∑–∞–º–µ—á—É –∞–Ω–æ–º–∞–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å."
    bot.send_message(message.chat.id, text)

# –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
threading.Thread(target=monitor_logic, daemon=True).start()

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
bot.polling(non_stop=True)
